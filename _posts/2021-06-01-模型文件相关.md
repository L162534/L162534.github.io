---
layout:  post
title:  模型文件相关
subtitle:  keep moving
date:  2021-06-01
author:  LY
catalog:  true
tags:
    -tensorflow
---

# Protocol Buffer(protobuf)

protobuf是谷歌开源的一种数据存储语言

1. 数据结构定义

   定义一个**students.pbtxt**的文件

   ```python
   student_info {
       name: 'Zhang San';
       age: 20;
       sex: 0;
   }
   
   student_info {
       name: 'Li Si';
       age: 25;
       sex: 0;
   }
   
   student_info {
       name: 'Wang Wu';
       age: 18;
       sex: 1;
   }
   ```

   定义一个**student_info.proto**文件

   ```C++
   syntax = "proto3"; //指定使用的protobuf的版本
   
   package proto_test; //指定本proto文件所在文件夹的名字
   
   message Student { //定义一个学生的数据格式
       string name = 1; //数字表示序列化后的二进制数据的顺序
       int32 age = 2;
       int32 sex = 3;        
   }
   
   message StudentInfo { //定义多个学生在一起的集合
       repeated Student student_info = 1;        
   }
   ```

   定义完数据解析格式后，执行下列指令，将解析格式转换成python语言

   ```
   protoc proto_test/*.proto --python_out=.
   ```

   会自动生成**student_info_pb2.2py**,内容如下：

   ```python
   # Generated by the protocol buffer compiler.  DO NOT EDIT!
   # source: proto_test/student_info.proto
   
   import sys
   _b=sys.version_info[0]<3 and (lambda x:x) or (lambda x:x.encode('latin1'))
   from google.protobuf import descriptor as _descriptor
   from google.protobuf import message as _message
   from google.protobuf import reflection as _reflection
   from google.protobuf import symbol_database as _symbol_database
   # @@protoc_insertion_point(imports)
   
   _sym_db = _symbol_database.Default()
   
   
   
   
   DESCRIPTOR = _descriptor.FileDescriptor(
     name='proto_test/student_info.proto',
     package='proto_test',
     syntax='proto3',
   ...
   ```

2. 读取.pbtxt文件

   ```python
   import tensorflow as tf
   from google.protobuf import text_format
   import student_info_pb2
   
   with tf.gfile.GFile(path, 'r') as fid:
           pbtxt_string = fid.read()
           pbtxt = student_info_pb2.StudentInfo()
           text_format.Merge(pbtxt_string, pbtxt) # 此时pbtxt_string里的数据已经按照pbtxt的数据格式存储在pbtxt中
   
           
   result_dict = {}
   for student_info in pbtxt.student_info: # 读取数据
   result_dict[student_info.name] = [student_info.age, student_info.sex]
   print(students_dict)
   >>>{'Li Si': [25, 0], 'Wang Wu': [18, 1], 'Zhang San': [20, 0]}
   ```

   

# 模型文件：

* checkpoint(.ckpt)

  只保存模型参数，保存方式就是name到value的映射

  通过tf.train.Saver()生成

* GraphDef(.pb)

  只包含了计算图以及张量和变量的定义，没有对应的value

  .pb是二进制文件，也有.pbtxt文本格式，用文本格式虽然可以更加直观地看到数据内容，但是用文本保存权值会占用大量空间

  * 有的程序直接用.pb文件作为预训练模型，是因为将GraphDef的变量全部冻结了，将变量全部换成训练好的常量形式，属于FrozenGraphDef格式。

* SavedModel

  相当于checkpoint和GraphDef的结合体

check

> 参考链接：
>
> https://www.jianshu.com/p/3de6ffc490a9

