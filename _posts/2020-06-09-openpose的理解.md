---
layout:  post
title:  openpose的理解
subtitle:  keep moving
date:  2020-06-09
author:  L&X
catalog:  true
tags:
    -pose estimate
    -C++
---

# 特色

##  自下而上的检测方法

​	多人姿态估计的实现思路大致分为两种，一种是自上而下：先检测出图像中人体的位置，标出对应的anchor，再从anchor中对每个人进行单人姿态估计，找出关节点的位置，但是这种方法的精度容易受到人体检测器的影响，要是人没找准，那关节点就更找不准了，除此之外，这种算法的复杂度会随着人数的增加而显著增加；另一种就是Openpose采用的自下而上的方式，先找到图像中所有人的关节点位置，再将关节点按照一定的策略将关节点拼接起来最终形成人体骨架。下图中，上面是通过MASK R—CNN先找到人所在的anchor，再对anchor进行单人姿态估计；下面是用Openpose的方法，找到了所有的关节点，最后再连接起来。

![openpose-1](\img\openpose-1.png)

## 部位亲和场

​	部位亲和场（Part Affinity Fields）是是一个图像矢量，它是从一个关节点指向另一个关节点的矢量。这个特征的设计是让我最为佩服的一点，正是这个特征的设计让后面的关节点连接策略非常的简单！下面先对这个概念讲解一下：

![](\img\openpose-2.jpg)

​	假设红色箭头是肢体向量，并规定向右为正，向上为正；因为二维矢量图无法用一张图来表示，我们将其分为两张图，一张是X方向的分量图，另一张是Y方向的分量图，将肢体矢量分解到X，Y两个方向上，各个方向矢量图像中像素值的绝对值表示原图像在该方向的分量值，正负表示方向。

## 热图（Heatmap）

热图是一种概率图形式，所有像素点的值都在0~1之间，如果将我们所需要预测出的关节点的像素点及其邻域进行高斯分布处理，并将像素值转化成概率值，就形成了热图。为什么要用热图作为神经网络的输出特征呢？

* 图像中往往并不止有一个点能描述关节点的位置，如果用一个点作为关节点的groundTruth,会盲目地对其他同样满足条件的关节点进行抑制，增加训练的难度。

* 试想：我们如果要求一个网络从一张432*368的图像中准确的找到目标像素点的位置，这近乎是不可能的，往往会让网络不收敛。

* 人体的身体结构一般情况下在图像中是固定的，因此关节点之间具有很强的相关性，如果之用单个像素点描述关节点位置会使神经网络难以学习到这种相关性

![](\img\openpose-4.png)

## 神经网络结构

![](\img\openpose-3.jpg)

​	

​	图中的特征图F是通过VGG16的前十层对原图像进行中间特征提取形成的中间特征，然后将中间特征送入到两分支多阶段的CNN中。每一个阶段都有中间监督。

​	其中S是输出的热图特征图，L是输出的paf特征图。COCO数据集将人体分为18个关节点，因此设定S共有19维（加上背景），每一维的图像表示了所有人同一类关节点的概率分布；根据COCO的肢体连接情况共分成17类肢体，但是为了适应背面人群的检测，额外增加了左耳-左肩、右耳-右肩的paf，因此L共有19*2=38维paf特征图。

**18张heatmap：**

![18张heatmap](\img\openpose-6.png)

**19张X方向paf矢量图：**

![](C:\Users\lenovo\Documents\GitHub\L162534.github.io\img\openpose-7.png)

**19张Y方向paf矢量图：**

![](\img\openpose-8.png)

> 可以看出水平肢体的X方向paf图和垂直肢体的Y方向paf图更加高亮。

​	网络中热图分支的groundtruth是将COCO数据集中经过预处理成热图的形式，paf分支也是将原图进行预处理：当像素点属于肢体范围内，将其的像素值设为1方向顺着肢体的方向并分解到X,Y方向上形成两幅矢量图作为paf的groundtruth。为了不断修正关节点的位置，同时利用关节点和肢体之间的联系，采用了多阶段特征融合回归，将第一阶段预测出的heatmap和paf再与原中间特征F一同送入下一阶段再次训练，每一阶段都会有一个损失函数。在最开始的阶段，神经网络可能也会跟人一样产生错觉：将左腕识别成右腕（毕竟人是个对称的生物），但随着多阶段不断地融合回归，像素点的感受野越来越大，全局信息越来越多，再加上paf与关节点的相关性，会促使网络逐步纠错。

![](\img\openpose-5.png)

​	上图中在第一阶段误将左手腕识别成右手腕，但是随着后面阶段的矫正，逐渐预测出正确的关键点。下面是我天马行空的想象过程：最开始感受野较小左右手腕都长得差不多，但是随着后面感受野越来越大，如果将之前的左手腕当成是右手腕，假设人是正面朝向，按道理来说顺着该手腕的胳膊的右边应该有人的躯干但是没找到，反而在左边找到了人体的躯干，那就还有一种可能，人是背面朝向，但是我检测到了眼睛鼻子，所以可以判断这个右手腕是误判，要及时修正。

## 关节点聚合

​	得到了我们想要的heatmap和paf特征图，接下来我们就可以在heatmap中找到每一个关节点范围中概率值最大的像素点作为我们的预测点，从而形成peak峰值图，其维度与heatmap相同，每一维度只显示同一种关节点的分布位置。这里我们就得到了所有关节点的位置，接下来我们要做的就是将这些点拼接成人体骨架。

![](\img\openpose-10.png)

​	我们目前的问题时按照什么策略进行拼接？我们首先将问题分解成如何确定两个关节点之间的连接，如上图中，我们找到了三个人关节点对，从图（a）可以看出我们有很多种连接方式，如何避免类似图（b）的错误，生成图（c）的正确连接呢？我们之前提到的**部位亲和场**就派上了用场。我们定义
$$
E = \int_{u=0}^{u=1}paf(p(u))\cdot vdu
$$

$$
p\left(u\right)=\left(1-u\right)d_{j1}+ud_{j2}
$$

​	E是亲和力，p(u)是像素点的位置，paf(p(u))是p(u)点在paf图上的向量，v是肢体的单位向量，这个公式就是为了衡量两个关节点之间构成的线段与paf图上的肢体矢量的对齐程度，对齐程度越高，亲和力越大。实际上，我们预测出的paf图已经可以大致勾勒出图像中人的肢体形状：

![](\img\openpose-11.png)

​	这也是为什么后面我们聚合算法会采用非常简单的策略的原因所在。整体的流程如下图（按照大佬的代码理解的，有错误的话欢迎批评指正）：

![](\img\openpose-9.png)

1. 首先从Peak图中找到所有的关节点并存入关节点列表，并将这些点在heatmap图上的概率值作为score存入列表；
2. 根据每种肢体对应的两种类节点，在列表中找到所有这两类的关节点，两两匹配根据公式算出亲和力，将亲和力很高的关节点对存入候选者肢体列表，将两个点的heatmap+E作为肢体候选者的score；
3. 此时，可能会出现两个相同种类的肢体共享一个关节点的情况（当人与人拥挤在一起时，可能会出现paf重叠的情况，这就导致一个点与另外两个点在paf上的积分可能都很高），因此我们对肢体候选者列表按照score进行排序，优先选用分数高的肢体，去除多余的肢体；
4. 新建人体骨架的结构，包括18个关节点、匹配成功关节点的数量cnum和肢体平均的置信度score，将之前的肢体列表一一匹配到人体骨架中。具体措施就是:先根据第一类肢体创建人体骨架，然后再遍历其他种类的肢体，根据人体骨架中是否含有该肢体的关节点，来确定这个肢体是否属于该人体骨架。
5. 生成的人体骨架列表中可能会有些骨架检测出的节点较少，因此我们去除那些关节点较少的人体骨架，得到最终的人体骨架列表。

说了这么多，其核心就是**只考虑关节点与关节点之间的连接，并不考虑关节点是否属于同一个人，当我们将关节点连接完后，连接起来的肢体自然而然的形成了人体骨架。**按照我自己的理解，造成这种现象的原因是paf本身构成了对关节点连接的显性约束，paf图已经勾勒出人体骨架的大致形状，所以我们不需要考虑非相邻节点的影响。